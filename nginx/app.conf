upstream auth_static {
    # upstream: 백엔드 서버 그룹을 정의해서 proxy_pass에서 이름만으로 라우팅할 수 있게 한다.
    # server: 실제 대상 호스트:포트를 지정한다.
    # keepalive 풀(여러 worker가 동일 커넥션을 재사용)
    server auth-web-static:4173;
    keepalive 16;
}

map $upstream_http_x_user_id $auth_user_id {
    # map: 입력 변수에 따라 출력 변수를 매핑하는 디렉티브.
    # default: 어떤 패턴에도 매치되지 않을 때 사용할 기본값.
    default $upstream_http_x_user_id;
}

map $upstream_http_x_user_role $auth_user_role {
    default $upstream_http_x_user_role;
}

# Prefer bearer from cookie `token` when present; otherwise use incoming Authorization header.
map $cookie_token $auth_header {
    ""       $http_authorization;
    default  "Bearer $cookie_token";
}

server {
    # server: 가상 서버 블록. 해당 블록에서 listen/server_name 등 가상 호스트 설정을 정의한다.
    listen 80;
    server_name _;

    client_max_body_size 10m;

    location / {
        # location: 특정 URI 패턴과 매칭되는 요청 처리 블록.
        # proxy_pass: 요청을 지정한 upstream 또는 실제 URL로 전달한다.
        proxy_pass http://auth_static;
        # proxy_set_header: 업스트림에 전달할 HTTP 헤더 값을 덮어쓴다.
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /internal/auth {
        # location = : 정확히 같은 경로에만 매칭.
        # internal: 외부 요청으로는 접근할 수 없고 내부 리다이렉션으로만 호출 가능.
        internal;
        proxy_pass http://auth-service:8080/auth/validate;
        proxy_set_header Host $host;
        proxy_set_header Authorization $auth_header;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Method $request_method;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
    }

    location ~ ^/api/v1/auth/(signup|login|refresh)$ {
        # location ~ : 정규식 매칭을 의미하며 대소문자를 구분한다.
        # ^/api/v1/auth/(signup|login|refresh)$ 는 signup/login/refresh 세 엔드포인트만 매칭.
        # 공개 인증 API는 토큰 검증 없이 바로 auth-service로 전달.
        proxy_pass http://auth-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        # 기타 /api/* 요청은 auth_request를 통해 사전 인증을 수행.
        auth_request /internal/auth;
        auth_request_set $auth_user_id $upstream_http_x_user_id;

        proxy_pass http://auth-service:8080;
        proxy_set_header X-User-Id $auth_user_id;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /auth/validate {
        # 클라이언트가 직접 인증 서버의 validate 엔드포인트를 호출하는 경우.
        proxy_pass http://auth-service:8080/auth/validate;
        proxy_set_header Host $host;
        proxy_set_header Authorization $http_authorization;
    }

    # Media service proxy
    location /media {
        auth_request /internal/auth;
        auth_request_set $auth_user_id $upstream_http_x_user_id;
        auth_request_set $auth_user_role $upstream_http_x_user_role;

        client_max_body_size 20m;
        proxy_pass http://media-service:4000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Authorization $auth_header;
        proxy_set_header X-User-Id $auth_user_id;
        proxy_set_header X-User-Role $auth_user_role;
    }
    # error_page: 특정 상태 코드 발생 시 다른 위치나 콘텐츠로 매핑.
    error_page 401 = @unauthorized;

    location @unauthorized {
        # location @name: 명명된 내부 location, error_page 등에서 참조한다.
        # default_type: 응답의 Content-Type 헤더를 지정한다.
        default_type application/json;
        return 401 '{"message":"Unauthorized"}';
    }
}
